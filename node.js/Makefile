#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License, Version 1.0 only
# (the "License").  You may not use this file except in compliance
# with the License.
#
# You can obtain a copy of the license at COPYING
# See the License for the specific language governing permissions
# and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at COPYING.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#
# Copyright (c) 2012, Joyent, Inc.  All rights reserved.
# Copyright (c) 2013 Andrew Stormont.  All rights reserved.
#

MAJOR_VER =	0.8
VER =	node-v0.8.14

include ../Makefile.defs

CFLAGS +=	-Wno-unknown-pragmas

#
# Node's build system is super broken.  If we pass it LIBS at configure time,
# it ignores it.  If we pass it LIBS at make time, it completely replaces all
# libraries, including those the build system itself would normally add.
# So our only option is to add this to LDFLAGS, which has to be passed at
# build time... including for the install target, because the generated
# makefiles have missing dependencies and rebuild stuff when installing.
# This has to be the most complicated, baroque, pointlessly wrong way
# imaginable to build something with a few dozen source files.  The next time
# you are here reading this and trying to work around the next piece of
# Node build stupidity, just stop.  Rip all this out, write a simple makefile,
# and copy it in at unpack time like we do for bzip2.
#
LDFLAGS +=	-lumem

#
# Disable dtrace for now as it causes the build to fail on old illumos versions
#
AUTOCONF_OPTS += \
	--without-dtrace \
	--openssl-use-sys \
	--openssl-libpath=$(DESTDIR)/lib \
	--openssl-includes=$(DESTDIR)/usr/include \
	--shared-zlib \
	--shared-zlib-libpath=$(DESTDIR)/lib \
	--shared-zlib-includes=$(DESTDIR)/usr/include \
	--prefix=/usr/node/$(MAJOR_VER)

AUTOCONF_CFLAGS =	CFLAGS="$(CPPFLAGS) $(CFLAGS)"
AUTOCONF_LIBS =
AUTOCONF_ENV +=		CXXFLAGS="$(CPPFLAGS) $(CFLAGS)"

# The build process wants libssl.so.1.0.0 which may not be installed
AUTOCONF_ENV +=		LD_LIBRARY_PATH="$(DESTDIR)/usr/lib"

OVERRIDES +=	$(AUTOCONF_ENV)

AUTOCONF_OUT =	build/default/config.h

all: all_autoconf

# - platform_node_version.js is autogenerated with the current node version
# - we move man pages as we want them in /usr/node/0.8/man
install: install_autoconf
	mkdir -p $(DESTDIR)/usr/node/$(MAJOR_VER)/node_modules
	./build_require_platform_node_version.sh \
	$(DESTDIR) \
	$(DESTDIR)/usr/node/$(MAJOR_VER)/bin/node \
	$(DESTDIR)/usr/node/$(MAJOR_VER)/node_modules/platform_node_version.js
	rm -rf $(DESTDIR)/usr/node/$(MAJOR_VER)/man
	mv $(DESTDIR)/usr/node/$(MAJOR_VER)/share/man \
	    $(DESTDIR)/usr/node/$(MAJOR_VER)/

include ../Makefile.targ
